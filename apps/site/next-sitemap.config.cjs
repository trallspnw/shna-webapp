const resolveVercelURL = (value) => (value ? `https://${value}` : undefined)

const SITE_URL =
  process.env.NEXT_PUBLIC_SITE_URL ||
  resolveVercelURL(process.env.VERCEL_PROJECT_PRODUCTION_URL) ||
  'https://example.com'

const CMS_URL =
  process.env.NEXT_PUBLIC_CMS_URL ||
  process.env.CMS_PUBLIC_URL ||
  resolveVercelURL(process.env.VERCEL_PROJECT_PRODUCTION_URL) ||
  'http://localhost:3000'

const fetchCollection = async (collection) => {
  const url = new URL(`/api/${collection}`, CMS_URL)
  url.searchParams.set('limit', '1000')
  url.searchParams.set('pagination', 'false')
  url.searchParams.set('depth', '0')

  const response = await fetch(url.toString())
  if (!response.ok) {
    throw new Error(`Failed to fetch ${collection} for sitemap`)
  }

  return response.json()
}

const fetchSiteSettings = async () => {
  const url = new URL('/api/globals/site-settings', CMS_URL)

  const response = await fetch(url.toString())
  if (!response.ok) {
    throw new Error('Failed to fetch site settings for robots.txt')
  }

  return response.json()
}

/** @type {import('next-sitemap').IConfig} */
module.exports = {
  siteUrl: SITE_URL,
  generateRobotsTxt: true,
  alternateRefs: [
    { href: `${SITE_URL}/en`, hreflang: 'en' },
    { href: `${SITE_URL}/es`, hreflang: 'es' },
  ],
  robotsTxtOptions: {
    policies: [
      {
        userAgent: '*',
        disallow: '/admin/*',
      },
    ],
    transformRobotsTxt: async (config, robotsTxt) => {
      const settings = await fetchSiteSettings()
      if (settings?.allowIndexing === true) return robotsTxt

      return [
        '# robots.txt generated by next-sitemap',
        'User-agent: *',
        'Disallow: /',
        '',
        '# Host',
        `Host: ${config.siteUrl}`,
        '',
      ].join('\n')
    },
  },
  additionalPaths: async (config) => {
    const pages = await fetchCollection('pages')

    const pagePaths = pages.docs
      .filter((page) => page.slug)
      .flatMap((page) => {
        const slugPath = page.slug === 'home' ? '' : `/${page.slug}`
        return ['en', 'es'].map((locale) => ({
          loc: `${config.siteUrl}/${locale}${slugPath}`,
          lastmod: page.updatedAt,
        }))
      })

    return [
      {
        loc: `${config.siteUrl}/en`,
        priority: 1.0,
      },
      {
        loc: `${config.siteUrl}/es`,
        priority: 1.0,
      },
      ...pagePaths,
    ]
  },
}
